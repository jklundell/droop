'''
Count election using CfER WIGM STV

Copyright 2011 by Jonathan Lundell

This file is part of Droop.

    Droop is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Droop is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Droop.  If not, see <http://www.gnu.org/licenses/>.


v4c for technical review

An act to add Chapter 2 (commencing with Section 10050) to Part 1
of Division 10 of the Elections Code, relating to elections.

LEGISLATIVE COUNSEL'S DIGEST
[TDB]

THE PEOPLE OF THE STATE OF CALIFORNIA DO ENACT AS FOLLOWS:
SECTION 1. Chapter 2 (commencing with Section 10050) is added to Part 1 of
Division 10 of the Elections Code, to read:


CHAPTER 2. RANKED VOTING

10050. Any city, county, or city and county may conduct a local election using ranked
voting in which voters rank the candidates for office in order of preference.
Ranked voting elections may be used for single-winner elections, such as
Mayor or City Attorney, or for elections that elect multiple candidates to
office, such as an at-large city council. Ranked voting elections are tabulated in rounds
as specified in Section 10058 for single-winner elections and Section 10059
for multiple-winner elections. General provisions for both single-winner
elections and multiple-winner elections are specified in this chapter.

10051. Nothing in this chapter shall be construed to preempt the right
of any charter city, charter county, or charter city and county to
provide in its charter for conduct of its elections,
and the manner in which, the
method by which, the times at which, and the terms for which its
elected officers are elected.

10052.  A city or county may not conduct a local election
using ranked voting unless that election is conducted on a voting
system that is capable of conducting the election using ranked voting
and that voting system has been approved by the Secretary of State
pursuant to Division 19 (commencing with Section 19001), or by
another procedure that has been approved by the Secretary of State,
which at minimum includes detailed specifications for counting,
auditing, and reporting of results.

10053. The following definitions apply for purposes of this chapter:
  (a) "Continuing ballot" means a ballot that counts for some candidate.
  (b) "Continuing candidate" means a qualified candidate that has neither
been elected nor defeated.
  (c) "Majority of votes" means more than 50 percent of the votes from
continuing ballots.
  (d) "Qualified candidate" means a candidate listed on the ballot for
this election or a write-in candidate qualified for participation in
this election.
  (e) "Ranked voting" means an election method in which voters rank the
candidates for office in order of preference, and the ballots are
counted in rounds that, in the case of a single-winner election,
simulate a series of runoffs until only two candidates remain, with the
one having the greater number of votes being declared the winner, or in
the case of multiple-winner elections, until all seats to be elected
have been filled.
  (f) "Ranking" for a candidate on a voter's ballot is a number
assigned to that candidate by the voter to express his or her
preference for that candidate. A higher ranking is a ranking with a
smaller numerical value, reflecting that a first choice ranking
indicates a greater preference for a candidate than a second choice
ranking. A lower ranking is a ranking with a larger numerical value.
  (g) "Overvote ranking" is a ranking that is assigned to more than one
qualified candidate.
  (h) "Highest ranked continuing candidate" on a ballot is the
continuing candidate with a ranking that has a smaller numerical value
than any ranking for any other continuing candidate on that ballot and
there is not an overvote ranking with a smaller or equal numerical
value. A ballot that does not have a "highest ranked continuing
candidate" is counted pursuant to subdivision (c) of Section 10057.
  (i) "Defeat set" is a group of continuing candidates consisting of a
continuing candidate and all other continuing candidates with fewer or
equal votes.

10054. A voting method authorized by
this chapter may be adopted by either of the following means:
   (a) By approval of a ballot measure or charter amendment submitted to the
voters by the governing body of the city or county at an election
pursuant to Division 9 (commencing with Section 9000).
   (b) By initiative ordinance or charter amendment adopted pursuant to
Division 9 (commencing with Section 9000).

10055. A city or county using ranked voting in a local election
shall conduct a voter education and outreach campaign to familiarize voters
with ranked voting in English and in every language in which a ballot is made
available to voters in that city or county. The voter education and outreach
campaign shall include public service announcements on radio or television or
in the print media that are disseminated consistently with the language
assistance requirements of the federal Voting Rights Act of 1965 (42 U.S.C.
Sec. 1973aa-1a).

10056.
  (a) A ranked voting ballot shall allow voters to rank as many choices
as there are candidates. If the voting equipment cannot feasibly
accommodate a number of rankings on the ballot equal to the number of
candidates, the elections official may limit the number of choices a
voter may rank to the maximum number allowed by the equipment. This
limit shall never be less than three.
  (b) The ballot shall not interfere with a voter's ability to rank at
least two write-in candidates. For the purposes of this section, a ranking
for an unqualified write-in candidate shall not be considered a ranking
for a candidate.

10057.
  (a) In the first or any round, if a ballot reaches a ranking with no
candidate indicated, that ballot shall immediately be advanced to the
next ranking. If a ballot reaches a ranking for an unqualified write-in candidate
as described in subdivision (b) of Section 10056, that ballot shall
immediately be advanced to the next ranking.
  (b) If two or more candidates tie for the fewest votes, the candidate
to be defeated shall be chosen by lot in a manner similar to that
described by subdivision (a) of Section 15651, except that subdivision
(b) of Section 15651 shall not apply, and the candidate chosen by lot
shall be defeated.
  (c) When a ballot is to be counted for the highest ranked continuing
candidate on the ballot, but the ballot does not have a highest ranked
continuing candidate, the ballot shall not be counted for any candidate
and shall be counted as an undervote, overvote, or exhausted ballot,
pursuant to this subdivision. If the ballot does not indicate any
ranking for a qualified candidate, the ballot shall be declared an
"undervote." If the ballot indicates an overvote ranking, the ballot
shall be declared an "overvote." If the ballot has a ranking for a
qualified candidate and does not have any overvote rankings, the ballot
shall be declared "exhausted." A ballot that has been declared an
undervote, overvote, or exhausted shall remain so for the remainder of
the tabulation.

10058. Ranked voting pursuant to Section 10050 for an election to
elect a single candidate to office shall be known as "instant runoff voting"
and shall be tabulated in a series of one or more rounds, each conducted in
the following manner:
  (a) In the first round, every ballot shall be counted for the highest
ranked continuing candidate on that ballot.
  (b) The "votes for a continuing candidate" are the number of ballots
counting for that candidate.
  (c) In the first round, if there is only one continuing candidate,
that candidate shall be declared elected and the tabulation is complete.
  (d) If there are exactly two continuing candidates:
    (1) The candidate with a majority of votes from the continuing
ballots shall be declared elected.
    (2) If both candidates have the same number of votes, the tie
shall be resolved pursuant to Section 15651 and the selected
candidate shall be declared elected.
    (3) The continuing candidate not declared elected shall be
declared defeated and the tabulation is complete.
  (e) If a continuing candidate has a majority of votes and the
tabulation cannot feasibly continue until there are only two continuing
candidates, the tabulation may be terminated after declaring the
majority candidate elected and declaring all other continuing
candidates defeated.
  (f) All of the candidates in the largest defeat set, if any exists,
that satisfies both of the following conditions may be declared
defeated.
    (1) There are at least two continuing candidates that are not in
the defeat set.
    (2) The total votes for all candidates in the defeat set is less
than the fewest votes for any continuing candidate that is not in
the defeat set.
  (g) If no candidates were declared defeated in this round pursuant to
subdivision (f), one continuing candidate is defeated as follows:
    (1) The continuing candidate with the fewest votes shall be
declared defeated.
    (2) If two or more continuing candidates are tied for having the
fewest votes, one of those candidates shall be chosen by lot and
declared defeated.
  (h) Each ballot that is counting for a candidate defeated in
subdivision (f) or (g) shall be transferred to and counted for the
highest ranked continuing candidate on that ballot.
  (i) The tabulation continues with a new round, starting with
subdivision (b).

10059. Ranked voting pursuant to Section 10050 for an election to
elect two or more candidates to office shall be known as "choice voting" and
shall be tabulated in a series of one or more rounds, each conducted in the
following manner:
  (a) In the first round:
    (1) All ballots shall be counted and each ballot shall be
transferred to and counted for the highest ranked continuing
candidate on that ballot, using a transfer value of 1.00000.
    (2) The "threshold", which is the number of votes needed to assure
being elected, shall be determined by dividing the total number of
ballots cast for that office, excluding undervotes as defined in
Section 10057, by one more than the number of offices to be filled
and then adding one vote, and then disregarding any fraction, as
shown in the following formula:
The total number of ballots cast, excluding undervotes as
defined in Section 10057, divided by the sum of one plus the number
of offices to be filled, plus one, disregarding any fraction, equals
the threshold.
  (b) The "votes for a continuing candidate" are the sum of the
transfer values of all ballots counting for that candidate.
  (c) In the first round, if the number of continuing candidates is
less than or equal to the number of offices to be filled, all
continuing candidates shall be declared elected and the tabulation is
complete.
  (d) For each continuing candidate with votes greater than or equal to
the threshold, the candidate shall be declared elected. The surplus
for the candidate is the votes for the candidate that are in excess of
the threshold.
  (e) If the number of elected candidates is equal to the number of
offices to be filled, all continuing candidates shall be declared
defeated and the tabulation is complete.
  (f) Optionally, defeat candidates pursuant to subdivision (k).
  (g) If no candidates were declared defeated in this round pursuant to
subdivision (f) and there are one or more elected candidates with
surplus, the surplus of each of those elected candidates shall be
transferred as follows:
    (1) Each ballot counting for the elected candidate shall be
transferred to and counted for the highest ranked continuing
candidate on that ballot using a new transfer value.
    (2) The new transfer value is that part of the previous transfer
value that is in proportion to the elected candidate's surplus as a
part of the votes for the elected candidate, as shown in the
following formula:
The previous transfer value, multiplied by the elected candidate's
surplus, divided by the votes for the elected candidate, truncated
to five decimal places is the new transfer value.
    (3) While ballots are being transferred from the elected
candidate, the surplus and the votes for the elected candidate do
not change. After all ballots are transferred from the elected candidate
and for the remainder of the tabulation, the elected candidate does not
have a surplus and the votes for the elected candidate is set equal to
the threshold.
  (h) If no candidates were declared defeated in this round pursuant to
subdivision (f) and no surplus was transferred in this round pursuant
to subdivision (g), one continuing candidate is defeated as follows:
    (1) The continuing candidate with the fewest votes shall be
declared defeated.
    (2) If two or more continuing candidates are tied for having the
fewest votes, one of those candidates shall be chosen by lot and
declared defeated.
  (i) If any candidates were declared defeated in this round pursuant
to subdivision (f) or subdivision (h):
    (1) If the number of continuing candidates plus the number of
elected candidates is equal to the number of offices to be filled,
all continuing candidates shall be declared elected and the
tabulation is complete.
    (2) For each candidate declared defeated in this round, each
ballot assigned to that candidate shall be transferred to and
counted for the highest ranked continuing candidate on that ballot
using the previous transfer value.
  (j) The tabulation continues with a new round, starting with
subdivision (b).
  (k) The "total surplus" is the sum of the surpluses of each elected
candidate with a surplus. All of the candidates in the largest defeat set, if any
exists, that satisfies all three of the following conditions may be
declared defeated.
    (1) The number of continuing candidates not in the defeat set,
plus the number of elected candidates is greater than or equal to
the number of offices to be filled.
    (2) The sum of the votes for all candidates in the
defeat set, plus the total surplus, is less than the fewest votes
for any continuing candidate not in the defeat set.
    (3) One of the following conditions is satisfied:
      (A) The number of elected candidates is one less than the
number of offices to be filled.
      (B) The number of continuing candidates not in the defeat set,
plus the number of elected candidates is equal to the number of
offices to be filled.
      (C) The sum of the votes for all candidates in the
defeat set, plus the total surplus is less than the difference
between the threshold and the most votes for any continuing
candidate.
      (D) The total surplus is zero and the sum of the votes for all
candidates in the defeat set, minus the most votes for
any one candidate in the defeat set, is less than the difference
between the threshold and the most votes for any continuing
candidate.

10060.
  (a) The instructions to the voters for an election that uses ranked
voting shall read substantially as follows: "To vote in this
election, indicate by selecting or marking a '1' in the voting square
to the right of your first choice, a '2' in the voting square to the
right of your second choice, a '3' in the voting square to the right of
your third choice, and so on. Do not give the same number to more than
one candidate. You may rank as many or as few of the candidates as you
choose, up to the limit specified, if any. Your second choice will not
hurt your first choice, your third choice will not hurt your first two
choices, and so on. You may include one or more qualified write-in
candidates in your rankings by writing each person's name in one of the
blank spaces provided for that purpose after the names of the other
candidates for the same office, and then writing the desired ranking in
the voting square to the right of that name."
  (b) The instructions may be modified as appropriate for the specific
voting system used, as long as the intent of this chapter is preserved.

10061.  (a) As soon as possible after the close of polls of a
ranked voting election, the local elections official shall make
ballot record reports available to the public as set forth in
section 10064. The "ballot record report" for an election
means a report that lists, for each ballot, the candidate or
candidates indicated at each ranking, the precinct of the ballot, and
whether the ballot was cast by mail. In the report, the ballots
shall be listed in an order that does not permit the order in which
they were cast in each precinct to be reconstructed.
   (b) The local elections official shall also make a summary report
and a comprehensive report available to the public after each ranked
voting election as set forth in section 10064.
The "summary report" for a race means a report that
lists the candidate vote totals in each round, along with the
cumulative numbers of undervotes, overvotes, and exhausted ballots in
each round.
   (c) The "comprehensive report" for a race means a report that
categorizes the numbers in the summary report by precinct. The report
shall list, for each round, the number of ballots cast in each
precinct that count as votes for each candidate in that round, that
have been declared undervotes, that have been declared overvotes up
to that point, and that have been declared exhausted up to that
point.
   (d) The local elections official shall make preliminary versions
of the summary report and ballot record report available as soon as
possible after the commencement of the official canvass of the vote
pursuant to Section 15301 and prior to the 1 percent manual tally
pursuant to Section 15360. The summary report, ballot record report,
comprehensive report, and preliminary versions of the summary report
and ballot record report shall be made available to the public during
the canvass on the Internet and by other means. The ballot record
report and preliminary versions of the ballot record report shall be
made available in a plain text electronic format.
  (e) An entry in the summary report shall equal the total of
corresponding entries in the comprehensive report for every precinct.
Whether a candidate is declared elected or defeated and the round in
which a candidate is declared defeated or elected shall be the same for
the summary report and for every precinct in the comprehensive report.
  (f) If the race is tabulated pursuant to Section 10058, the votes for
each round in a summary report or in a comprehensive report shall be
reported as of the completion of subdivision (b) of Section 10058.
Each ballot that is counted as an undervote, overvote, or as exhausted
is counted as one vote.
  (g) If the race is tabulated pursuant to Section 10059, the votes for
each round in a summary report or in a comprehensive report shall be
reported as of the completion of subdivision (b) of Section 10059.
Each ballot that is counted as an undervote, an overvote, or as
exhausted is counted as having the number of votes equal to the
ballot's transfer value.

10062. The local elections official shall make available to the public a
summary report, comprehensive report, and ballot record report prior to
the manual tally pursuant to Section 15360. A batch of ballots shall
be fully reported in those reports or an updated version of those
reports before that batch is tallied pursuant to Section 15360.

10063. A manual tally pursuant to Section 15360 for a ranked voting
race shall be conducted using one of the following methods:
  (a) Ballots are tallied in a manner that if all ballots for a precinct
were tallied, with guidance from the summary report, the vote totals
should independently produce the vote totals in the comprehensive
report for that precinct.
  (b) All ballot rankings are compared to and should exactly match the
corresponding rankings in the ballot record report.

10064. Any reports made available to the public pursuant to Sections
10061, 10062, or 10063 shall be promptly posted on the official Internet Web
site for the city or county. A ballot record report that is made available on
the Internet shall be made available in a plain text electronic format. If a
city or county does not have an official Internet Web site, the local
elections official shall promptly make the reports available to the public by
other means and notice of the availability of the reports shall be
prominently displayed in an appropriate public location of the city's or
county's election division.

10065. A ranked voting election that is hand counted pursuant to Section
10058 shall be hand counted using the procedures of Article 5 (commencing
with Section 15270) and Article 6 (commencing with Section 15290) of Chapter
3 of Division 15, as applicable, with the following adjustments.
  (a) Each ranked voting race shall be counted separately.
  (b) Each group of ballots that is transferred shall be first sorted
into different stacks by highest ranked continuing candidate,
undervote, overvote, and exhausted. Each stack shall then be counted
and tallied, pursuant to Sections 15276 and Sections 15277.
  (c) The transfer tally counts shall be recorded on a vote total
sheet and accumulated with previous vote totals to produce vote totals
for the round, pursuant to subdivision (b) of Section 10058.
  (d) Those vote totals shall be consolidated, as needed, to produce
vote totals for the round by precinct and for entire race.
  (e) Each stack of ballots shall be labeled with the round, the
candidate or other category for which they count, the transfer tally,
and the accumulated vote total. Each stack is then placed with other
ballots previously transferred to the same candidate or other category
so that each set of transferred ballots can be easily distinguished,
for example by setting one on top of another, rotated by 90 degrees.
  (f) Any summation of ballot counts or vote counts shall be independently
confirmed by a second member of the precinct board or counting board.
  (g) When a ranked voting race is hand counted an additional time to
account for additional ballots or different interpretations of ballot
markings, some of the ballot and vote counts from a previous hand count
of that race may be used in lieu of counting the ballots again when it
can be shown that those counts are relevant to the new hand count.

10066. A ranked voting election that is hand counted pursuant to
Section 10059 shall be hand counted using the procedures of Section 10065
with the following adjustments.
  (a) Both ballot counts and vote counts shall be determined whenever a
group of ballots is transferred, accumulated, or consolidated.
  (b) A transfer of votes for a group of ballots shall be counted one
of the following ways:
    (1) Ballots that are transferred together to the same candidate or
other category and having the same transfer value are stacked and
labeled together.
      (A) The total votes for the group are the ballot count for the
group multiplied by their common transfer value.
      (B) The label for such a group shall include the round, the
candidate or other category for which they count, the transfer
ballot count, the transfer vote count, and their common transfer
value.
      (C) When ballots being transferred to a candidate or other
category consist of several such groups, their transfer ballot
and vote counts shall be recorded and totaled.
    (2) The transfer value for a ballot is tracked individually or
reconstructed as needed. The vote count for a group of ballots
being transferred to the same candidate or other category is the sum
of their individual vote counts.
  (c) Any determination of transfer value shall be independently confirmed
by a second member of the precinct board or counting board.


For reference:

15651.  (a) If at any election, except as provided in subdivision
(b) and an election for Governor or Lieutenant Governor, two or more
persons receive an equal and the highest number of votes for an
office to be voted for in more than one county, the Secretary of
State shall forthwith summon the candidates who have received the tie
votes, whether upon the canvass of the returns by the Secretary of
State or upon recount by a court, to appear before him or her at the
Secretary of State's office at the State Capitol at a time to be
designated by him or her. The Secretary of State shall at that time
and place determine the tie by lot. Except as provided in subdivision
(b), in the same manner, at a time and place designated by it, the
election board shall determine a tie vote, whether upon the canvass
of the returns by the election board or upon a recount by a court,
for candidates voted for wholly within one county or city.
'''

from __future__ import absolute_import
from .electionmethods import MethodWIGM

class Rule(MethodWIGM):
    '''
    Rule for counting CfER WIGM elections

    Parameters: batch defeat selected by rule name
    '''

    #  options
    #
    method = 'wigm'     # underlying method
    precision = 5       # fixed-arithmetic precision in digits

    @classmethod
    def ruleNames(cls):
        "return supported rule name or names"
        return ('cfer', 'cfer-batch')

    @classmethod
    def helps(cls, helps, name):
        "create help string for cfer"
        h =  "%s is CfER STV\n" % name
        if name.endswith('batch'):
            h += '  (batch defeat)\n'
        else:
            h += '  (single defeat)\n'
        h += '\noptions: none\n'
        helps[name] = h

    def __init__(self, E):
        "initialize rule"
        self.E = E
        self.defeat_batch = None
        self.name = None

    def options(self):
        "initialize election parameters"

        self.name = self.E.options.getopt('rule')
        self.defeat_batch = self.name.endswith('batch')
        self.E.options.setopt('arithmetic', default='fixed', force=True)
        self.E.options.setopt('precision', default=self.precision, force=True)
        self.E.options.setopt('display', default=self.precision, force=True)

    def info(self):
        "return an info string for the election report"
        if self.defeat_batch:
            return "CfER (batch defeat)"
        return "CfER (single defeat)"

    def tag(self):
        "return a tag string for unit tests"
        return self.name

    #########################
    #
    #   Main Election Counter
    #
    #########################
    def count(self):
        "count the election"

        #  local support functions
        #
        def hasQuota(candidate):
            '''
            Determine whether a candidate has a quota.
            '''
            return candidate.vote >= E.quota

        def hasSurplus(candidate):
            '''
            Determine whether a candidate has a surplus.
            '''
            return candidate.vote > E.quota

        def calcQuota():
            '''
            Calculate quota.
            '''
            ##  10059(a)(2) The "threshold", which is the number of votes needed to assure
            ##  being elected, shall be determined by dividing the total number of
            ##  ballots cast for that office, excluding undervotes as defined in
            ##  Section 10057, by one more than the number of offices to be filled
            ##  and then adding one vote, and then disregarding any fraction, as
            ##  shown in the following formula:
            ##  The total number of ballots cast, excluding undervotes as
            ##  defined in Section 10057, divided by the sum of one plus the number
            ##  of offices to be filled, plus one, disregarding any fraction, equals
            ##  the threshold.
            ##
            return V(E.nBallots) / V(E.nSeats+1) + V.epsilon

        def transfer(ballot):
            "Transfer ballot to next hopeful candidate."
            while not ballot.exhausted and ballot.topCand not in C.hopeful():
                ballot.advance()
            if ballot.exhausted:
                E.exhausted += ballot.vote
            else:
                ballot.topCand.vote += ballot.vote

        def breakTie(E, tied, reason=None):
            '''
            break a tie

            reason must be 'surplus' or 'elect' or 'defeat',
            indicating whether the tie is being broken for the purpose
            of choosing a surplus to transfer, a winner, or a candidate to defeat.
            
            Note that we are using the tie-breaking order from the election profile
            rather than the in-person 15651(a) mechanism.
            '''
            ##  10057(b) If two or more candidates tie for the fewest votes, the candidate
            ##  to be defeated shall be chosen by lot in a manner similar to that
            ##  described by subdivision (a) of Section 15651, except that subdivision
            ##  (b) of Section 15651 shall not apply, and the candidate chosen by lot
            ##  shall be defeated.
            ##
            ##  10059(h)(2) If two or more continuing candidates are tied for having the
            ##  fewest votes, one of those candidates shall be chosen by lot and
            ##  declared defeated.
            ##
            ##  15651(a) If at any election, except as provided in subdivision
            ##  (b) and an election for Governor or Lieutenant Governor, two or more
            ##  persons receive an equal and the highest number of votes for an
            ##  office to be voted for in more than one county, the Secretary of
            ##  State shall forthwith summon the candidates who have received the tie
            ##  votes, whether upon the canvass of the returns by the Secretary of
            ##  State or upon recount by a court, to appear before him or her at the
            ##  Secretary of State's office at the State Capitol at a time to be
            ##  designated by him or her. The Secretary of State shall at that time
            ##  and place determine the tie by lot. Except as provided in subdivision
            ##  (b), in the same manner, at a time and place designated by it, the
            ##  election board shall determine a tie vote, whether upon the canvass
            ##  of the returns by the election board or upon a recount by a court,
            ##  for candidates voted for wholly within one county or city.
            ##
            assert(reason == 'defeat') # the only valid reason is 'defeat'
            if len(tied) == 1:
                return tied.pop()
            t = C.byTieOrder(tied)[0]
            names = ", ".join([c.name for c in tied])
            E.logAction('tie', 'Break tie (%s): [%s] -> %s' % (reason, names, t.name))
            return t

        def batchDefeat():
            '''
            find the largest defeat set
            '''
            ##  10059(k) The "total surplus" is the sum of the surpluses of each elected
            ##  candidate with a surplus. All of the candidates in the largest defeat set, if any
            ##  exists, that satisfies all three of the following conditions may be
            ##  declared defeated.
            ##
            ##      (1) The number of continuing candidates not in the defeat set,
            ##  plus the number of elected candidates is greater than or equal to
            ##  the number of offices to be filled.
            ##      (2) The sum of the votes for all candidates in the
            ##  defeat set, plus the total surplus, is less than the fewest votes
            ##  for any continuing candidate not in the defeat set.
            ##      (3) One of the following conditions is satisfied:
            ##        (A) The number of elected candidates is one less than the
            ##  number of offices to be filled.
            ##        (B) The number of continuing candidates not in the defeat set,
            ##  plus the number of elected candidates is equal to the number of
            ##  offices to be filled.
            ##        (C) The sum of the votes for all candidates in the
            ##  defeat set, plus the total surplus is less than the difference
            ##  between the threshold and the most votes for any continuing
            ##  candidate.
            ##        (D) The total surplus is zero and the sum of the votes for all
            ##  candidates in the defeat set, minus the most votes for
            ##  any one candidate in the defeat set, is less than the difference
            ##  between the threshold and the most votes for any continuing
            ##  candidate.
            ##
            surplus = sum([(c.vote - E.quota) for c in C.pending()], V0)
            cands = C.hopeful(order='vote')
            defeatSet = []
            nElected = len(C.elected())
            for t in xrange(len(cands)-1):
                trialSet = cands[:t+1]  # trial defeat set is low t+1 candidates
                nextc = cands[t+1]      # nextc is low candidate not in defeat set
                #
                #  (1) don't defeat too many candidates
                #
                if (len(cands[t+1:]) + nElected) < E.nSeats:
                    break
                #
                #  (2) best possible vote for candidate in defeat set must
                #      be lower than other continuing candidates
                #
                votesDefeatSet = sum([c.vote for c in trialSet], V0)
                if (votesDefeatSet + surplus) >= nextc.vote:
                    continue
                #
                #  (3)(A) if only one seat remains unfilled, we needn't worry about
                #         order of election
                #  (3)(B) if the remaining continuing candidates will be automatically
                #         together, we needn't worry about order of election
                #  (3)(C) if defeat-set votes plus surplus can't elect best continuing
                #         candidate, we won't disturb order of election
                #  (3)(D) relax (C) when we see that the high candidate in the defeat set 
                #         would be defeated next per (h)
                #
                if ((nElected + 1) == E.nSeats) or \
                   (len(cands)-len(trialSet)+nElected) == E.nSeats or \
                   (votesDefeatSet + surplus) < (E.quota - cands[-1].vote) or \
                   surplus == V0 and (votesDefeatSet - cands[t].vote) < (E.quota - cands[-1].vote):
                    defeatSet = trialSet  # trial set is current largest defeat set
            return defeatSet


        #  Local variables for convenience
        #
        E = self.E  # election object
        C = E.C     # candidates
        V = E.V     # arithmetic value class
        V0 = E.V0   # constant zero

        ##  10059. Ranked voting pursuant to Section 10050 for an election to
        ##  elect two or more candidates to office shall be known as "choice voting" and
        ##  shall be tabulated in a series of one or more rounds, each conducted in the
        ##  following manner:
        ##    (a) In the first round:
        ##      (1) All ballots shall be counted and each ballot shall be
        ##  transferred to and counted for the highest ranked continuing
        ##  candidate on that ballot, using a transfer value of 1.00000.
        ##
        E.quota = calcQuota()
        for b in E.ballots:
            b.topCand.vote += b.vote
        E.exhausted = V0  # track non-transferable votes
        E.logAction('begin', 'Begin Count')

        while True:

            E.newRound()    # start a new round

            ##    (b) The "votes for a continuing candidate" are the sum of the
            ##  transfer values of all ballots counting for that candidate.
            ##    (c) In the first round, if the number of continuing candidates is
            ##  less than or equal to the number of offices to be filled, all
            ##  continuing candidates shall be declared elected and the tabulation is
            ##  complete.
            ##
            if E.round == 1:
                if len(C.hopeful()) <=  E.nSeats:
                    for c in C.hopeful():
                        c.elect(msg='Elect all')
                    break

            ##    (d) For each continuing candidate with votes greater than or equal to
            ##  the threshold, the candidate shall be declared elected. The surplus
            ##  for the candidate is the votes for the candidate that are in excess of
            ##  the threshold.
            ##
            for c in [c for c in C.hopeful(order='vote', reverse=True) if hasQuota(c)]:
                c.elect(pending=hasSurplus(c))  # elect, note transfer pending

            ##    (e) If the number of elected candidates is equal to the number of
            ##  offices to be filled, all continuing candidates shall be declared
            ##  defeated and the tabulation is complete.
            ##
            if len(C.elected()) >= E.nSeats:
                for c in C.pending():
                    c.unpend()
                for c in C.hopeful():
                    c.defeat(msg='Defeat remaining')
                break

            ##    (f) Optionally, defeat candidates pursuant to subdivision (k).
            ##
            defeats = self.defeat_batch and batchDefeat()
            if defeats:
                for c in C.byBallotOrder(defeats):
                    c.defeat(msg='Defeat batch')

            ##    (g) If no candidates were declared defeated in this round pursuant to
            ##  subdivision (f) and there are one or more elected candidates with
            ##  surplus, the surplus of each of those elected candidates shall be
            ##  transferred as follows:
            ##
            elif C.pending():
                ##
                ##      (1) Each ballot counting for the elected candidate shall be
                ##  transferred to and counted for the highest ranked continuing
                ##  candidate on that ballot using a new transfer value.
                ##      (2) The new transfer value is that part of the previous transfer
                ##  value that is in proportion to the elected candidate's surplus as a
                ##  part of the votes for the elected candidate, as shown in the
                ##  following formula:
                ##  The previous transfer value, multiplied by the elected candidate's
                ##  surplus, divided by the votes for the elected candidate, truncated
                ##  to five decimal places is the new transfer value.
                ##      (3) While ballots are being transferred from the elected
                ##  candidate, the surplus and the votes for the elected candidate do
                ##  not change. After all ballots are transferred from the elected candidate
                ##  and for the remainder of the tabulation, the elected candidate does not
                ##  have a surplus and the votes for the elected candidate is set equal to
                ##  the threshold.
                ##
                for c in C.pending():
                    c.unpend('Transfer surplus')
                    surplus = c.vote - E.quota
    
                    for b in (b for b in E.ballots if b.topRank == c.cid):
                        b.weight = (b.weight * surplus) / c.vote
                        transfer(b)
                    c.vote = E.quota
                    E.logAction('transfer', "Surplus transferred: %s (%s)" % (c, surplus))

            ##    (h) If no candidates were declared defeated in this round pursuant to
            ##  subdivision (f) and no surplus was transferred in this round pursuant
            ##  to subdivision (g), one continuing candidate is defeated as follows:
            ##
            else:
                ##      (1) The continuing candidate with the fewest votes shall be
                ##  declared defeated.
                ##      (2) If two or more continuing candidates are tied for having the
                ##  fewest votes, one of those candidates shall be chosen by lot and
                ##  declared defeated.
                ##
                low_vote = min(c.vote for c in C.hopeful())
                low_candidates = [c for c in C.hopeful() if c.vote == low_vote]
                low_candidate = breakTie(E, low_candidates, 'defeat')
                low_candidate.defeat()
                defeats = [low_candidate]

            ##    (i) If any candidates were declared defeated in this round pursuant
            ##  to subdivision (f) or subdivision (h):
            ##
            if defeats:
                ##
                ##      (1) If the number of continuing candidates plus the number of
                ##  elected candidates is equal to the number of offices to be filled,
                ##  all continuing candidates shall be declared elected and the
                ##  tabulation is complete.
                ##
                if (len(C.hopeful()) + len(C.elected())) <= E.nSeats:
                    for c in C.pending():
                        c.elect(msg='Elect pending')
                    for c in C.hopeful():
                        c.elect(msg='Elect remaining')
                    break

                ##      (2) For each candidate declared defeated in this round, each
                ##  ballot assigned to that candidate shall be transferred to and
                ##  counted for the highest ranked continuing candidate on that ballot
                ##  using the previous transfer value.
                ##
                cids = [c.cid for c in defeats]
                for b in (b for b in E.ballots if b.topRank in cids):
                    transfer(b)
                for c in defeats:
                    c.vote = V0
                E.logAction('transfer', "Transfer defeated: %s" % ", ".join(str(c) for c in defeats))
                
            ##    (j) The tabulation continues with a new round, starting with
            ##  subdivision (b).
